name: Status Label Management

on:
  issues:
    types: [opened, closed, reopened, labeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]

permissions:
  issues: write
  contents: read
  pull-requests: read

env:
  STATUS_RECEIVED: "status: received"
  STATUS_INVESTIGATING: "status: investigating"
  STATUS_IMPLEMENTING: "status: implementing"
  STATUS_COMPLETE: "status: complete"
  STATUS_BLOCKED: "status: blocked"
  STATUS_UNBLOCKED: "status: no longer blocked"
  STATUS_CANCELED: "status: canceled"
  STATUS_CANCELED_DUPLICATE: "status: canceled - duplicate"
  STATUS_CANCELED_CANT_REPRO: "status: canceled - can not reproduce"
  STATUS_CANCELED_NOT_PLANNED: "status: canceled - not planned"

jobs:
  new-issue:
    name: New Issue - Add Received Label
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Add received label
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "$STATUS_RECEIVED"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  team-comment:
    name: Team Comment - Move to Investigating
    if: github.event_name == 'issue_comment' && github.event.action == 'created' && github.event.issue.state == 'open'
    runs-on: ubuntu-latest
    steps:
      - name: Check and update status
        run: |
          # Get current labels
          LABELS=$(gh issue view ${{ github.event.issue.number }} --json labels -q '.labels[].name')

          # Check if commenter is the issue author
          IS_AUTHOR="${{ github.event.comment.user.login == github.event.issue.user.login }}"

          # If has "received" and commenter is not author, move to investigating
          if echo "$LABELS" | grep -qF "$STATUS_RECEIVED" && [ "$IS_AUTHOR" = "false" ]; then
            gh issue edit ${{ github.event.issue.number }} \
              --remove-label "$STATUS_RECEIVED" \
              --add-label "$STATUS_INVESTIGATING"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  issue-closed:
    name: Issue Closed - Set Completion Status
    if: github.event_name == 'issues' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Set completion status
        run: |
          # Get current labels
          LABELS=$(gh issue view ${{ github.event.issue.number }} --json labels -q '.labels[].name')

          # Remove active status labels
          for label in "$STATUS_RECEIVED" "$STATUS_INVESTIGATING" "$STATUS_IMPLEMENTING" "$STATUS_BLOCKED" "$STATUS_UNBLOCKED"; do
            if echo "$LABELS" | grep -qF "$label"; then
              gh issue edit ${{ github.event.issue.number }} --remove-label "$label" 2>/dev/null || true
            fi
          done

          # If no cancel status already set, add "complete"
          if ! echo "$LABELS" | grep -q "status: canceled"; then
            gh issue edit ${{ github.event.issue.number }} --add-label "$STATUS_COMPLETE"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  issue-reopened:
    name: Issue Reopened - Restore Status
    if: github.event_name == 'issues' && github.event.action == 'reopened'
    runs-on: ubuntu-latest
    steps:
      - name: Restore investigating status
        run: |
          # Get current labels
          LABELS=$(gh issue view ${{ github.event.issue.number }} --json labels -q '.labels[].name')

          # Remove closed statuses
          for label in "$STATUS_COMPLETE" "$STATUS_CANCELED" "$STATUS_CANCELED_DUPLICATE" "$STATUS_CANCELED_CANT_REPRO" "$STATUS_CANCELED_NOT_PLANNED"; do
            if echo "$LABELS" | grep -qF "$label"; then
              gh issue edit ${{ github.event.issue.number }} --remove-label "$label" 2>/dev/null || true
            fi
          done

          # Add investigating
          gh issue edit ${{ github.event.issue.number }} --add-label "$STATUS_INVESTIGATING"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  label-added:
    name: Status Label Added - Handle Transitions
    if: github.event_name == 'issues' && github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - name: Handle status label change
        run: |
          ADDED_LABEL="${{ github.event.label.name }}"
          ISSUE_NUM="${{ github.event.issue.number }}"

          # Check if added label is a status label
          case "$ADDED_LABEL" in
            "status: received"|"status: investigating"|"status: implementing"|"status: complete"|"status: blocked"|"status: no longer blocked"|"status: canceled"|"status: canceled - duplicate"|"status: canceled - can not reproduce"|"status: canceled - not planned")
              # It's a status label - remove other status labels
              ALL_STATUS_LABELS="status: received,status: investigating,status: implementing,status: complete,status: blocked,status: no longer blocked,status: canceled,status: canceled - duplicate,status: canceled - can not reproduce,status: canceled - not planned"

              for label in $(echo "$ALL_STATUS_LABELS" | tr ',' '\n'); do
                if [ "$label" != "$ADDED_LABEL" ]; then
                  gh issue edit "$ISSUE_NUM" --remove-label "$label" 2>/dev/null || true
                fi
              done

              # If a close-appropriate label was added, close the issue
              case "$ADDED_LABEL" in
                "status: complete"|"status: canceled"|"status: canceled - duplicate"|"status: canceled - can not reproduce"|"status: canceled - not planned")
                  # Check if issue is open
                  STATE=$(gh issue view "$ISSUE_NUM" --json state -q '.state')
                  if [ "$STATE" = "OPEN" ]; then
                    gh issue close "$ISSUE_NUM"
                  fi
                  ;;
              esac
              ;;
          esac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  pr-merged:
    name: PR Merged - Unblock Dependent Issues
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Get linked issues and unblock dependents
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"

          echo "Processing merged PR #$PR_NUM"

          # Collect all linked issue numbers (deduplicated)
          LINKED_ISSUES=""

          # Method 1: GraphQL closingIssuesReferences (official links)
          echo "Querying GraphQL for officially linked issues..."
          GRAPHQL_ISSUES=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $pr: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $pr) {
                  closingIssuesReferences(first: 100) {
                    nodes {
                      number
                    }
                  }
                }
              }
            }
          ' -F owner="$OWNER" -F repo="$REPO" -F pr="$PR_NUM" \
            --jq '.data.repository.pullRequest.closingIssuesReferences.nodes[].number' 2>/dev/null || echo "")

          if [ -n "$GRAPHQL_ISSUES" ]; then
            echo "Found via GraphQL: $GRAPHQL_ISSUES"
            LINKED_ISSUES="$GRAPHQL_ISSUES"
          fi

          # Method 2: Text matching in PR title and body
          echo "Parsing PR title and body for issue references..."
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY=$(gh pr view "$PR_NUM" --json body -q '.body' 2>/dev/null || echo "")

          # Match patterns: Fixes #N, Closes #N, Resolves #N (case insensitive)
          TEXT_ISSUES=$(echo "$PR_TITLE $PR_BODY" | grep -oiE '(fix(es|ed)?|close[sd]?|resolve[sd]?):?\s*#[0-9]+' | grep -oE '[0-9]+' || echo "")

          if [ -n "$TEXT_ISSUES" ]; then
            echo "Found via text matching: $TEXT_ISSUES"
            LINKED_ISSUES="$LINKED_ISSUES $TEXT_ISSUES"
          fi

          # Deduplicate
          LINKED_ISSUES=$(echo "$LINKED_ISSUES" | tr ' ' '\n' | sort -u | grep -v '^$' | tr '\n' ' ')
          echo "All linked issues (deduplicated): $LINKED_ISSUES"

          if [ -z "$LINKED_ISSUES" ]; then
            echo "No linked issues found, skipping"
            exit 0
          fi

          # For each linked issue, find issues blocked by it and unblock them
          for ISSUE_NUM in $LINKED_ISSUES; do
            echo "Checking for issues blocked by #$ISSUE_NUM..."

            # Get issues that are blocked by this one
            BLOCKED_ISSUES=$(gh api "/repos/$OWNER/$REPO/issues/$ISSUE_NUM/dependencies/blocking" \
              --jq '.[].number' 2>/dev/null || echo "")

            if [ -z "$BLOCKED_ISSUES" ]; then
              echo "  No issues are blocked by #$ISSUE_NUM"
              continue
            fi

            echo "  Found blocked issues: $BLOCKED_ISSUES"

            for BLOCKED_NUM in $BLOCKED_ISSUES; do
              echo "  Updating issue #$BLOCKED_NUM to 'no longer blocked'..."

              # Get current labels
              LABELS=$(gh issue view "$BLOCKED_NUM" --json labels -q '.labels[].name' 2>/dev/null || echo "")

              # Only update if it has the blocked label
              if echo "$LABELS" | grep -qF "$STATUS_BLOCKED"; then
                gh issue edit "$BLOCKED_NUM" \
                  --remove-label "$STATUS_BLOCKED" \
                  --add-label "$STATUS_UNBLOCKED" 2>/dev/null || true

                gh issue comment "$BLOCKED_NUM" \
                  --body "Blocker #$ISSUE_NUM has been resolved (PR #$PR_NUM merged). This issue is no longer blocked." 2>/dev/null || true

                echo "  Updated #$BLOCKED_NUM"
              else
                echo "  #$BLOCKED_NUM does not have blocked label, skipping"
              fi
            done
          done

          echo "Done processing PR merge"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
